import{slideDown,slideUp,destroySlide,updateSlide}from"./slide";import{fadeIn,fadeOut,destroyFade,updateFade}from"./fade";import{scrollIntoView,setCSS}from"./animation";import{getHash,isValidHash,hashScroll,updateURL}from"./hash";import{validID,getToggleState,getIndexById,getElements,removeActiveClass,addActiveClass,getIdByIndex,defaultActiveSections,log}from"./helpers";import{debounce}from"./utils";import{validBreakpoints,isLive,responsive}from"./responsive";export class EasyTabAccordion{constructor(t){return this._class={enabled:"easy-tab-accordion-enabled",active:"active"},this._attr={container:"data-eta",trigger:"data-eta-trigger",receiver:"data-eta-receiver",hash:"data-eta-hash",hashScroll:"data-eta-hash-scroll",animation:"data-eta-animation"},this.originalOptions=t,this.initialize(),this.options.avoidDoubleClick&&(this.isAnimating=!0),{toggle:t=>this.toggle(t),toggleByIndex:t=>this.toggle(getIdByIndex(this,t)),destroy:()=>this.destroy(),init:()=>this.initialize(),update:()=>this.update()}}initialize(){this.setupData(),this.enabled&&!this.hasInitialized&&this.init(),!this.enabled&&this.hasInitialized&&this.destroy(),this.enabled&&(isValidHash(this)?this.toggle(getHash().id,"hash"):defaultActiveSections(this)),window.addEventListener("resize",debounce((t=>this.onResize(t)),300)),window.addEventListener("load",(t=>this.onLoad(t)))}setupData(){if(this.options={el:document.querySelector(`[${this._attr.container}]`),trigger:`[${this._attr.trigger}]`,triggerAttr:this._attr.trigger,receiver:`[${this._attr.receiver}]`,receiverAttr:this._attr.receiver,activeClass:this._class.active,animation:"slide",duration:450,hash:!1,hashScroll:!1,liveBreakpoint:[],avoidDoubleClick:!0,dev:!1,activeSection:0,allowCollapseAll:!1,allowExpandAll:!1,onBeforeInit:t=>{},onAfterInit:t=>{},onBeforeOpen:(t,i)=>{},onBeforeClose:(t,i)=>{},onAfterOpen:(t,i)=>{},onAfterClose:(t,i)=>{},onDestroy:t=>{},onUpdate:t=>{},...this.originalOptions},!this.options.el)return void log(this,"warn","ETA Error, target not found!");this.wrapper=this.options.el,this.current_id="",this.previous_id="",this.type="",this.hasInitialized=!1,this.enabled=!validBreakpoints(this)||isLive(this),this.count=this.wrapper.querySelectorAll(this.options.trigger).length,this.options.hash=!0===this.wrapper.hasAttribute(this._attr.hash)||this.options.hash,this.options.hashScroll=!0===this.wrapper.hasAttribute(this._attr.hashScroll)||this.options.hashScroll;const t=this.wrapper.getAttribute(this._attr.animation);this.options.animation=null!==t?t:this.options.animation}init(){this.options.onBeforeInit(this),this.hasInitialized=!0,this.wrapper.classList.add(this._class.enabled),this.wrapper.querySelectorAll(this.options.trigger).forEach((t=>{t.addEventListener("click",this.manualTriggerFunction.bind(this))})),this.dataset=[],this.wrapper.querySelectorAll(this.options.receiver).forEach((t=>{const i=t.getAttribute(this.options.receiverAttr);this.dataset.push({id:i,el:t,active:!1}),"fade"===this.options.animation&&(setCSS(t.parentElement,{overflow:"hidden",position:"relative"!==getComputedStyle(t).position?"relative":""}),setCSS(t,{position:"absolute"!==getComputedStyle(t).position?"absolute":"",inset:"0 0 auto"}))})),this.assignTriggerElements(),this.options.onAfterInit(this)}destroy(){switch(this.hasInitialized=!1,this.wrapper.classList.remove(this._class.enabled),this.wrapper.querySelectorAll(this.options.trigger).forEach((t=>{t.outerHTML=`${t.outerHTML}`})),this.dataset=[],this.options.animation){case"slide":destroySlide(this);break;case"fade":destroyFade(this)}this.options.onDestroy(this)}update(){switch(this.options.animation){case"slide":updateSlide(this);break;case"fade":updateFade(this)}this.options.onUpdate(this)}openPanel(t=this.current_id){if(!validID(this,t))return;(()=>{this.dataset[getIndexById(this,t)].active=!0,updateURL(this,t),this.options.onBeforeOpen(this)})();const i=i=>{hashScroll(this),this.options.onAfterOpen(this,i),log(this,"log","after open",t),this.options.avoidDoubleClick&&(this.isAnimating=!1)},{current:e}=getElements(this,t);switch(this.options.animation){case"slide":e.forEach((t=>slideDown(t,this.options.duration,(()=>i(t)))));break;case"fade":e.forEach((t=>fadeIn(t,this.options.duration,(()=>i(t)))))}addActiveClass(this,t);("fade"===this.options.animation||"slide"===this.options.animation&&!this.options.allowExpandAll)&&this.dataset.filter((i=>i.id!==t)).forEach((t=>{t.active&&this.closePanel(t.id)}))}closePanel(t=this.current_id){if(!validID(this,t))return;this.options.onBeforeClose(this),this.dataset[getIndexById(this,t)].active=!1;const i=i=>{this.options.onAfterClose(this,i),log(this,"log","after close",t),this.options.avoidDoubleClick&&(this.isAnimating=!1)},{current:e}=getElements(this,t);switch(this.options.animation){case"slide":e.forEach((t=>slideUp(t,this.options.duration,(()=>i(t)))));break;case"fade":e.forEach((t=>fadeOut(t,this.options.duration,(()=>i(t)))))}removeActiveClass(this,t)}toggle(t,i="undefined",e=!1){if(!validID(this,t))return void log(this,"warn","invalid id");const s=getToggleState(this,t);0!==s&&(this.type=i,this.previous_id=this.current_id?this.current_id:getIdByIndex(this,0),1===s?(this.current_id=t,this.openPanel(this.current_id)):this.closePanel(t))}onResize(t){this.update(),responsive(this,t)}onLoad(t){this.update(),responsive(this,t)}assignTriggerElements(){document.querySelectorAll('a[href^="#"]').forEach((t=>{const i=t.getAttribute("href"),e="#"===i[0]?i.slice(1):getHash(i).id;e&&this.dataset.forEach((i=>{i.id===e&&t.addEventListener("click",(t=>{t.preventDefault(),this.toggle(e,"manual"),scrollIntoView({context:this})}))}))}))}manualTriggerFunction(t){t.preventDefault(),t.stopPropagation();const i=t.target.getAttribute(this.options.triggerAttr)||t.target.closest(this.options.trigger).getAttribute(this.options.triggerAttr);this.toggle(i,"manual")}}document.querySelectorAll("[data-eta]").forEach((t=>new EasyTabAccordion({el:t})));